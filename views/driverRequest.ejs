<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <title>
        <%= title %>
    </title>
    <link rel='stylesheet' href='/css/style.css' />
    <script src="/js/jquery.js"></script>
    <script src="/js/moment.min.js"></script>
</head>

<body>
    <!-- <div class="container">
        <%- data %>
    </div> -->

    <!-- App Capsule -->
    <div id="appCapsule">
        <div id="request">
        </div>
    </div>
    <!-- * App Capsule -->

    <script src="/js/socket.io.js"></script>
    <script>
        $(document).ready(function () {
            let obj = {
                userId: '<%- userId %>',
                onlineStatus: '<%- onlineStatus %>',
                drivers: '<%- drivers %>',
                socketUrl: '<%- socketUrl %>'
            };
            const socket = io(obj.socketUrl, {
                transports: ['websocket'],
                allowUpgrades: false
            });
            //console.log("socket", socket);
            const $container = $('#appCapsule');
            const $request = $('#request');
            let primaryColor = '<%- themeSettings.primaryColor %>';
            let secondaryColor = '<%- themeSettings.secondaryColor %>';

            //console.log("primaryColor", primaryColor);



            console.log("obj dataaaa", obj);

            socket.on('connect', function () {
                console.log("socket>>>>>>>>>>>>", socket.connected);
                if(obj.onlineStatus === "online")
                getOrderRequest();
                socket.emit('join', obj, (ack) => {
                    console.log(ack.userId + ' Joined!');
                    console.log("ack" + ack);
                    updateStatusButton(ack);
                });
            });

            socket.on('order_driver_request', (data) => {
                getOrderRequest();
                //location.reload();
            });

            function getOrderRequest() {
                console.log('orderRequest obj', obj);

                socket.emit('orderRequest', obj, (orders) => {
                    console.log('orderRequest', orders);
                    if (orders.length > 0) {
                        console.log("order length");
                        
                        viewOrderRequest(orders)
                    } else {
                        console.log("order check");

                        $request.html(`<h4 class="text-center lead" style="padding-top:321px;">No Request Found</h4>`);
                    }
                });
            }

            function viewOrderRequest(orders) {

                let body = '';

                body += `<div class="section full mt-0 mb-3">
            <ul class="listview image-listview media mb-2" id="searchlist">`;
                orders.forEach(order => {

                    //console.log("order.user.profileImage", order.user.profileImage);

                    let name = order.user.name;
                    let profileImage = '/images/user.jpg';

                    if (order.user.profileImage) {
                        profileImage = (typeof order.user.profileImage.link != "undefined" ? order.user.profileImage.link : '/images/user.jpg');
                    }

                    let orderTotal = order.orderTotal;
                    let address = order.vendor.address;
                    let localDate = moment(order.date_created_utc).local().format('DD/MM/YYYY');
                    let localTime = moment(order.date_created_utc).local().format('LT');

                    body += `<li>
                    <div class="item list-card">
                        <div class="imageWrapper">
                            <div class="list-card-image  w80">
                                <a href="#"
                                    onclick="myFunction({'screen':'RestaurantDetail', 'url':'http://app.bestwebdevs.com/food-demo/restaurant.html'});">
                                    <img src="${profileImage}" class="card-img-top img-fluid user-img">
                                </a>
                            </div>
                        </div>
                        <div class="in">
                            <div class="position-relative">
                                <div class="list-card-body">
                                    <h6 class="mb-1"><a href="#"
                                            onclick="myFunction({'screen':'RestaurantDetail', 'url':'http://app.bestwebdevs.com/food-demo/restaurant.html'});"
                                            class="text-black">${name}
                                        </a>
                                    </h6>
                                    <ul class="details-list">
                                        <li>
                                            <div class="icon-svg">
                                                <svg style="fill: ${secondaryColor} !important;" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg"
                                                    xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                                    viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;"
                                                    xml:space="preserve">
                                                    <g>
                                                        <g>
                                                            <path d="M256,0C161.896,0,85.333,76.563,85.333,170.667c0,28.25,7.063,56.26,20.49,81.104L246.667,506.5
                                           c1.875,3.396,5.448,5.5,9.333,5.5s7.458-2.104,9.333-5.5l140.896-254.813c13.375-24.76,20.438-52.771,20.438-81.021
                                           C426.667,76.563,350.104,0,256,0z M256,256c-47.052,0-85.333-38.281-85.333-85.333c0-47.052,38.281-85.333,85.333-85.333
                                           s85.333,38.281,85.333,85.333C341.333,217.719,303.052,256,256,256z" />
                                                        </g>
                                                    </g>
                                                </svg>
                                            </div>
                                            <div class="list-text">${address}</div>
                                        </li>
                                        <li>
                                            <div class="icon-svg">
                                                <!-- Generator: Adobe Illustrator 19.0.0, SVG Export Plug-In . SVG Version: 6.00 Build 0)  -->
                                                <svg style="fill: ${secondaryColor} !important;" version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg"
                                                    xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                                    viewBox="0 0 512 512" style="enable-background:new 0 0 512 512;"
                                                    xml:space="preserve">
                                                    <g>
                                                        <g>
                                                            <path
                                                                d="M452,40h-24V0h-40v40H124V0H84v40H60C26.916,40,0,66.916,0,100v352c0,33.084,26.916,60,60,60h392
                                           c33.084,0,60-26.916,60-60V100C512,66.916,485.084,40,452,40z M472,452c0,11.028-8.972,20-20,20H60c-11.028,0-20-8.972-20-20V188
                                           h432V452z M472,148H40v-48c0-11.028,8.972-20,20-20h24v40h40V80h264v40h40V80h24c11.028,0,20,8.972,20,20V148z" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="76" y="230" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="156" y="230" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="236" y="230" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="316" y="230" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="396" y="230" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="76" y="310" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="156" y="310" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="236" y="310" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="316" y="310" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="76" y="390" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="156" y="390" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="236" y="390" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="316" y="390" width="40" height="40" />
                                                        </g>
                                                    </g>
                                                    <g>
                                                        <g>
                                                            <rect x="396" y="310" width="40" height="40" />
                                                        </g>
                                                    </g>

                                                </svg>
                                            </div>
                                            <div class="list-text">
                                                ${localDate} <span class="line"></span> ${localTime}</div>
                                        </li>
                                        <li>
                                            <div class="icon-svg"></div><svg style="fill: ${secondaryColor} !important;" id="Capa_1"
                                                enable-background="new 0 0 512.026 512.026" height="512"
                                                viewBox="0 0 512.026 512.026" width="512"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <g>
                                                    <path
                                                        d="m155.779 97.026h199.228l41.733-67.098c3.635-5.845 2.826-13.413-1.962-18.357-4.761-4.915-12.239-5.981-18.18-2.609-.932.487-35.188 17.822-117.134-1.563-69.084-16.338-132.481-.619-135.146.058-4.603 1.17-8.38 4.45-10.183 8.843-1.803 4.394-1.419 9.381 1.035 13.446z" />
                                                    <path
                                                        d="m160.013 127.026c-8.284 0-15 6.716-15 15v4c0 8.284 6.716 15 15 15h192c8.284 0 15-6.716 15-15v-4c0-8.284-6.716-15-15-15z" />
                                                    <path
                                                        d="m414.722 365.46-65.262-174.434h-186.894l-65.262 174.434c-10.768 28.778-6.607 59.175 11.712 85.589 26.086 37.611 76.729 60.977 132.167 60.977h29.66c55.438 0 106.081-23.365 132.167-60.977 18.319-26.414 22.479-56.811 11.712-85.589zm-107.413 9.167c-2.946 17.528-15.952 35.294-36.279 41.362v6.694c0 8.284-6.716 15-15 15s-15-6.716-15-15v-5.176c-9.6-1.177-17.674-4.197-28.498-11.277-6.933-4.535-8.876-13.832-4.341-20.765 4.535-6.935 13.832-8.876 20.765-4.341 10 6.543 13.774 7.154 26.976 7.052 12.849-.085 20.304-9.662 21.794-18.523.898-5.349.531-14.984-12.032-19.425-15.387-5.438-31.137-11.657-42.101-20.258-10.982-8.613-16.012-23.48-13.125-38.798 3.129-16.602 14.711-29.818 30.227-34.492.114-.034.225-.062.339-.095v-5.561c0-8.284 6.716-15 15-15s15 6.716 15 15v4.563c10.448 2.562 17.675 7.61 21.046 9.966.315.221.59.417.828.575 7.004 3.97 9.647 12.81 5.887 19.998-3.839 7.341-12.904 10.181-20.243 6.339-1.327-.693-2.459-1.484-3.657-2.322-4.65-3.25-12.435-8.69-25.546-4.738-7.146 2.153-9.001 9.211-9.399 11.323-.779 4.14.088 8.013 2.159 9.638 7.579 5.945 21.23 11.211 33.584 15.577 22.849 8.079 35.556 29.25 31.616 52.684z" />
                                                </g>
                                            </svg>
                                            <div class="list-text">${orderTotal}</div>
                                        </li>
                                    </ul>

                                    <div class="footer-btn">
                                        <button style="color: ${secondaryColor} !important; border: 1px solid ${secondaryColor};" class="reject_order unfilled-btn" data-id="${order._id}" class="unfilled-btn"><svg style="fill: ${secondaryColor} !important;" id="Bold" enable-background="new 0 0 24 24"
                                                height="512" viewBox="0 0 24 24" width="512"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="m22.25 1h-2.5c-.965 0-1.75.785-1.75 1.75v11.5c0 .965.785 1.75 1.75 1.75h2.5c.965 0 1.75-.785 1.75-1.75v-11.5c0-.965-.785-1.75-1.75-1.75z" />
                                                <path
                                                    d="m5.119.75c-1.95 0-3.61 1.4-3.94 3.32l-1.12 6.5c-.42 2.45 1.46 4.68 3.94 4.68h4.72s-.75 1.5-.75 4c0 3 2.25 4 3.25 4s1.5-.5 1.5-3c0-2.376 2.301-4.288 3.781-5.273v-12.388c-1.601-.741-4.806-1.839-9.781-1.839z" />
                                            </svg>Decline</button>
                                        <button style="background: ${secondaryColor} !important; border: 1px solid ${secondaryColor};" class="accept_order filled-btn" data-id="${order._id}" class="filled-btn"><svg height="512" viewBox="0 0 16 16" width="512"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="m0 1v8c0 .552246.447693 1 1 1h3v-10h-3c-.552307 0-1 .447693-1 1z"
                                                    transform="translate(0 5)" />
                                                <path
                                                    d="m9.15332 5.02979h-2.9541c-.258301 0-.387695-.172363-.431152-.246582-.043457-.0737305-.131348-.270508-.0063477-.496094l1.0415-1.87549c.228516-.410645.251953-.893555.0649414-1.32471-.187012-.43164-.556152-.744629-1.0127-.858398l-.734375-.183594c-.178711-.0449219-.368164.0122071-.492676.150391l-3.9873 4.42969c-.413574.460449-.641113 1.0542-.641113 1.67236v5.23242c0 1.37842 1.12158 2.5 2.5 2.5l4.97412-.0004883c1.12305 0 2.11475-.756348 2.41113-1.83887l1.06738-4.89844c.03125-.13623.0473633-.275879.0473633-.415527 0-1.01807-.828613-1.84668-1.84668-1.84668z"
                                                    transform="translate(5 .97)" />
                                            </svg>Accept</button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </li>`
                });
                body += `</ul>
        </div>`;

                $request.html(body);
            }


            $(document).on('click', '#go_online', () => {
                getOrderRequest();
                obj.onlineStatus = $('#go_online').attr('data-status');
                console.log('obj online status22', obj);
                socket.emit('updateStatus', obj, (ack) => {
                    console.log('updateStatus', ack);
                    updateStatusButton(ack);
                });
            });

            function updateStatusButton(ack) {
                if (ack.onlineStatus === 'online') {
                    // $request.html(`<p></p>`);
                    $('.fab-button').remove();
                    $container.append(`<div class="fab-button text bottom-center btn-block pl-2 pr-2 border-r-50">
            <a style="background: ${secondaryColor} !important;" href="javascript:void(0);" id="go_online" data-status="offline" class="fab">GO OFFLINE</a>
        </div>`);
                } else if (ack.onlineStatus === 'offline') {
                    $request.html(`<p class="text-center"><img style="max-width:100%;" src="/images/go-online.png"/></p>`);
                    $('.fab-button').remove();
                    $request.html(`<p class="text-center"><img style="max-width:100%;" src="/images/go-online.png"/></p>`);
                    $container.append(`<div class="fab-button text bottom-center btn-block pl-2 pr-2 border-r-50">
            <a style="background: ${secondaryColor} !important;" href="javascript:void(0);" id="go_online" data-status="online" class="fab">GO ONLINE</a>
        </div>`);
                } else {
                    $request.html(`<p class="text-center"><a href="javascript:void(0);" id="go_track"  class="fab btn btn-block">Go To Trip</a></p>`);
                    callToRN(ack);
                    $('.fab-button').remove();
                }
            }

            $(document).on('click', '.accept_order', function (event) {
                //console.log($(event.target).attr('data-id'));
                obj.orderId = $(event.target).attr('data-id');
                obj.onlineStatus = 'pickupInroute';
                console.log('obj', obj, socket);
                try {
                    socket.emit('acceptOrder', obj, (ack) => {
                        console.log('updateStatus', ack);
                        getOrderRequest();
                        updateStatusButton(ack);
                    });
                } catch (error) {
                    console.log("err :", error);

                }

            });

            $(document).on('click', '#go_track', () => {
                callToRN(obj.drivers);
            });

            $(document).on('click', '.reject_order', function (event) {
                obj.orderId = $(event.target).attr('data-id');
                socket.emit('rejectOrder', obj, (ack) => {
                    console.log('updateStatus', ack);
                    getOrderRequest();
                    updateStatusButton(ack);
                });
            });

            function callToRN(order) {
                window.ReactNativeWebView.postMessage(JSON.stringify(order));
            }

            // function getData() {
            //     $.ajax({
            //         type: 'GET',
            //         url: '/',
            //         success: function (result) {
            //             $('#champ').html(result);
            //         }
            //     });
            // }
        });
    </script>
</body>

</html>